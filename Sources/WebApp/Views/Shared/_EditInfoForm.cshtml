@using ModelLib.Convert.Attributes;
@using ModelLib.Convert.Table;
@using ModelLib.DTO;
@using ModelLib.Model;
@using WebApp.Extensions;
@using WebApp.Models.PageModels;
@using WebApp.Settings;
@using System.ComponentModel.DataAnnotations;

@model DataEditor;

@{
    TranslateMetadata<IMetaData> meta = new();
    TableValueResult? result = new();

    string routing = string.Empty;

    switch (Model.TypeName)
    {
        case nameof(EquipmentDTO):
            meta.Assign<EquipmentDTO>();

            if (Model.DataValue != null)
                result = meta.GetValues<EquipmentDTO>(Model.DataValue, withNotInclude: true);

            routing = "send-edit-data-equipment";
            break;
        case nameof(UserDTO):
            meta.Assign<UserDTO>();

            if (Model.DataValue != null)
                result = meta.GetValues<UserDTO>(Model.DataValue, withNotInclude: true);

            routing = "send-edit-data-user";
            break;
    }
}

<div id="add-edit-container">
    <div id="add-edit-container-bg"></div>

    <div id="add-edit-form-container">
        <div id="add-edit-form-meta">
            <p id="add-edit-form-title">asdfafd</p>
            <button class="defaultButton" id="close-add-edit-form">X</button>
        </div>

        <form id="add-edit-form" method="post" action="@routing">
            @{
                if (result != null)
                {
                    <input value="@result["Id"]" name="Id" type="hidden" required/>

                    foreach (var property in meta.PropName)
                    {
                        if (meta.HasAttribute<SelectedValue>(property.Key))
                        {
                            <div class="add-edit-select-container">
                                <p class="add-edit-row-title">@property.Value</p>
                                <div class="custom-select">
                                    <select name="@property.Key" required>
                                        @{
                                            var res = result[property.Key];
                                            int? currentValue = (int)res?.GetType().GetProperties()[0].GetValue(res, null);

                                            if (res?.GetType().Name is string typeName)
                                            {
                                                var selections = await GetEditFormSelectionValues(typeName);
                                                if (selections != null)
                                                {
                                                    foreach (var selection in selections)
                                                    {
                                                        var type = selection.GetType();
                                                        var props = type.GetProperties();

                                                        int id = props[0].GetValue(selection, null);
                                                        string name = props[1].GetValue(selection, null);

                                                        bool isSelected = currentValue == id;

                                                        if (isSelected)
                                                        {
                                                            <option value="@id" selected>@name</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@id">@name</option>
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                        }
                        else
                        {
                            if (result[property.Key] is DateTime dateTime) 
                            {
                                <div class="add-edit-input-value-container">
                                    <p class="add-edit-row-title">@property.Value</p>
                                    <input type="date" name="@property.Key" class="add-edit-row-input-value" value="@dateTime.ToString("yyyy-MM-dd")" required>
                                </div>
                            }
                            else
                            {
                                <div class="add-edit-input-value-container">
                                    <p class="add-edit-row-title">@property.Value</p>
                                    @{
                                        if (meta.HasAttribute<RequiredAttribute>(property.Key))
                                        {
                                            <input type="text" name="@property.Key" class="add-edit-row-input-value" value="@result[property.Key]" required />
                                        }
                                        else
                                        {
                                            <input type="text" name="@property.Key" class="add-edit-row-input-value" value="@result[property.Key]" />
                                        }
                                    }
                                </div>
                            }
                        }
                    }
                }
            }
        </form>

        <div id="add-edit-form-buttons">
            <input type="submit" form="add-edit-form" class="defaultButton" id="change-send"/>
        </div>
    </div>
</div>

@{
    async Task<IEnumerable<dynamic>?> GetEditFormSelectionValues(string typeName)
    {
        List<dynamic>? selectionItems = typeName switch
        {
            "EquipmentType" => (await AppSettings.Api.Client.GetFromJsonAsync<List<EquipmentType>>(AppSettings.Api.ApiRequestUrl(ApiRequestType.EquipmentType, "all")))?.Cast<dynamic>().ToList(),
            "Permission" => (await AppSettings.Api.Client.GetFromJsonAsync<List<Permission>>(AppSettings.Api.ApiRequestUrl(ApiRequestType.Permission, "all")))?.Cast<dynamic>().ToList(),
            _ => null
        };

        return selectionItems;
    }
}